---
id: ctp-client
title: Commercetools Client
sidebar_label: Client (ctpClient)
---

import CodePackage from '@site/src/components/CodePackage';

<CodePackage name="@deity/falcon-commercetools-module" />

// TODO
- [ ] ctpIntroduction
- [ ] Authentication methods
- [x] Customer apiRoot
- [x] Integration apiRoot

If you need to access `ctpClient` in a new class, don't forget to [bind your service](/docs/next/platform/server-v3/modules/module-api#binding-services).

## ApiRoot
You can make use of the by Commercetools [TypeScript SDK](https://commercetools.github.io/nodejs/sdk) through the `apiRoot`. Our `ctpClient` provides two async methods to grab a pre-configured `apiRoot` where all required project configuration, authorization and session refreshing is handled.

With the `integrationApiRoot` requests in name of the [Commercetools project](https://docs.commercetools.com/merchant-center/projects) to commercetools could be made. Use this `apiRoot` for all requests where a signed-in user is not required. To make requests in name of the customer the `customerApiRoot` can be used.

#### Authorization
Requests made to Commercetools API are authenticated through auth middlewares. In our `ctpClient` the [createAuthMiddlewareWithExistingToken](https://commercetools.github.io/nodejs/sdk/api/sdkMiddlewareAuth.html#createauthmiddlewarewithexistingtokenauthorization-options) middleware is used, where a `Bearer` token is set to the request header.

When using our preconfigured apiRoot you don't need to worry about authorization or customer session management.  Where `integrationApiRoot` creates an authentication token based on your [configured](/docs/next/platform/integration/commercetools/configuration/falcon-server) `cliendId` and `clientSecret`, the `customerApiRoot` accesses the [ctpSession](./ctp-session) to get the customer token from session.

#### Authorization Token
When you don't need a full apiRoot, but you do want access to integration or customer tokens you can also directly request them through the `ctpClient`.

```typescript
const integrationToken = await this.ctpClient.getIntegrationToken();
const customerToken = await this.ctpClient.getCustomerToken();
```
:::caution
Although you can also access the customerToken directly from the `ctpSession`, we strongly advice to use the asynchronous method as shown above. Only then you are sure the returned token is validated and refreshed when necessary.
:::


### Integration apiRoot

#### Scopes
Our integration client only works correctly if the correct scopes has been assigned to it. Make sure you check the following when generating your accessToken in the Commercetools dashboard;
- `view_project_settings`
- `view_categories`
- `view_published_products`
- `view_products`
- `manage_orders`
- `manage_payments`
- `manage_customers`
- `view_customers`

#### Example
```ts
@injectable()
class ExampleIntegrationDatasource {
    constructor(@inject('CtpClient') protected ctpClient: CtpClient) {}

    async findById(id: string): Promise<CtpCategory> {
        const integrationApiRoot = await this.ctpClient.integrationApiRoot();
        const { body: category } = await integrationApiRoot
            .categories()
            .withId({ ID: id })
            .get()
            .execute();

        return category;
    }
}
```
## Customer apiRoot
When using `this.ctpClient.customerApiRoot()` you don't need to worry about refreshing sessions. Our `ctpClient` will refresh the `CtpAuthToken` when needed and store fresh token in our [session](./ctp-session).

#### Scopes
When a customer authenticates through our middleware, the following set of scopes will be requested;
- `view_stores`
- `view_orders`
- `view_payments`
- `view_shopping_lists`
- `manage_my_profile`
- `manage_orders`
- `manage_customers`
- `manage_my_orders`
- `manage_my_payments`
- `manage_my_shopping_lists`

#### Example
A cart belongs to a customer, whether this is a signed in customer or a guest filling his cart, we will interact with the API in the same way through the `customerApiRoot`.

```ts
@injectable()
class ExampleCustomerDatasource {
    constructor(@inject('CtpClient') protected ctpClient: CtpClient) {}

    async myCart() {
        const customerApiRoot = await this.ctpClient.customerApiRoot();
        const { body: cart } = await customerApiRoot
            .me()
            .activeCart()
            .get()
            .execute();

        return cart;
    }
}
```
